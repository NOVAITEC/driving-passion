{
  "name": "Dutch Market Search",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "search-dutch-market",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [250, 300]
    },
    {
      "parameters": {
        "jsCode": "// Build search parameters from vehicle data\nconst input = $input.first().json;\n\n// Handle different input structures (body, data, or direct)\nlet vehicle = null;\n\n// Check if data is a JSON string that needs parsing\nif (input.body && input.body.data && typeof input.body.data === 'string') {\n  try {\n    const parsedData = JSON.parse(input.body.data);\n    const listing = Array.isArray(parsedData) ? parsedData[0] : parsedData;\n    \n    // Map mobile.de scraper format to vehicle format\n    vehicle = {\n      make: listing.brand || '',\n      model: listing.model || '',\n      year: listing.attributes?.['First Registration'] \n        ? parseInt(listing.attributes['First Registration'].split('/')[1]) \n        : new Date().getFullYear(),\n      mileage_km: listing.attributes?.Mileage \n        ? parseInt(listing.attributes.Mileage.replace(/[^\\d]/g, '')) \n        : 0,\n      price_eur: listing.price?.total?.amount || 0,\n      fuelType: mapFuelTypeFromGerman(listing.attributes?.Fuel || 'Petrol'),\n      transmission: (listing.attributes?.Transmission || '').toLowerCase().includes('auto') ? 'automatic' : 'manual',\n      co2_gkm: listing.attributes?.['CO\\u2082 emissions (comb.)'] \n        ? parseInt(listing.attributes['CO\\u2082 emissions (comb.)'].replace(/[^\\d]/g, '')) \n        : 120,\n      listingUrl: listing.url || ''\n    };\n  } catch (e) {\n    // Not valid JSON, try other formats\n  }\n}\n\n// If not parsed yet, try direct vehicle data\nif (!vehicle) {\n  vehicle = input.body || input;\n  if (vehicle.body) vehicle = vehicle.body;\n}\n\nfunction mapFuelTypeFromGerman(fuel) {\n  const f = (fuel || '').toLowerCase();\n  if (f.includes('diesel')) return 'diesel';\n  if (f.includes('electr') || f.includes('elektr')) return 'electric';\n  if (f.includes('hybrid')) return 'hybrid';\n  if (f.includes('lpg') || f.includes('gas')) return 'lpg';\n  return 'petrol';\n}\n\n// Validate required fields\nif (!vehicle || !vehicle.make || !vehicle.model) {\n  throw new Error(`Missing required vehicle data. Keys: ${JSON.stringify(Object.keys(input.body || input))}`);\n}\n\n// Calculate mileage range (Â±10%)\nconst mileage = parseInt(vehicle.mileage_km) || 0;\nconst mileageMin = Math.floor(mileage * 0.9);\nconst mileageMax = Math.ceil(mileage * 1.1);\n\nconst searchParams = {\n  make: (vehicle.make || '').toLowerCase(),\n  model: (vehicle.model || '').toLowerCase(),\n  yearFrom: parseInt(vehicle.year) || new Date().getFullYear(),\n  yearTo: parseInt(vehicle.year) || new Date().getFullYear(),\n  mileageMin: mileageMin,\n  mileageMax: mileageMax,\n  originalVehicle: vehicle\n};\n\nreturn { json: searchParams };"
      },
      "id": "build-search-params",
      "name": "Build Search Parameters",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.apify.com/v2/acts/nocodeventure~marktplaats-auto-scraper/runs?token=apify_api_adWkgFGeghOnGBtcAgdLNDxcD3hNvK4c7Gp5",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"startUrls\": [\n    {\n      \"url\": \"https://www.marktplaats.nl/l/auto-s/{{ $json.make }}/f/{{ $json.model }}/\"\n    }\n  ],\n  \"maxPages\": 1,\n  \"maxResults\": 20,\n  \"scrapeDetails\": false\n}",
        "options": {
          "timeout": 30000
        }
      },
      "id": "start-apify-actor",
      "name": "Start Apify Scraper",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [650, 300],
      "credentials": {
        "httpQueryAuth": {
          "id": "apify-token",
          "name": "Apify Token"
        }
      }
    },
    {
      "parameters": {
        "amount": 45,
        "unit": "seconds"
      },
      "id": "wait-for-scraper",
      "name": "Wait 45s",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [850, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://api.apify.com/v2/actor-runs/{{ $('Start Apify Scraper').item.json.data.id }}?token=apify_api_adWkgFGeghOnGBtcAgdLNDxcD3hNvK4c7Gp5",
        "options": {
          "timeout": 30000
        }
      },
      "id": "check-run-status",
      "name": "Check Run Status",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1050, 300],
      "credentials": {
        "httpQueryAuth": {
          "id": "apify-token",
          "name": "Apify Token"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "is-succeeded",
              "leftValue": "={{ $json.data.status }}",
              "rightValue": "SUCCEEDED",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "is-finished",
      "name": "Is Finished?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1250, 300]
    },
    {
      "parameters": {
        "amount": 30,
        "unit": "seconds"
      },
      "id": "wait-more",
      "name": "Wait 30s More",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [1250, 500]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://api.apify.com/v2/actor-runs/{{ $('Start Apify Scraper').item.json.data.id }}/dataset/items?token=apify_api_adWkgFGeghOnGBtcAgdLNDxcD3hNvK4c7Gp5",
        "options": {
          "timeout": 30000
        }
      },
      "id": "get-results",
      "name": "Get Results",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1450, 200],
      "credentials": {
        "httpQueryAuth": {
          "id": "apify-token",
          "name": "Apify Token"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse Apify scraper results with filtering\nconst items = $input.first().json;\nconst searchParams = $('Build Search Parameters').first().json;\nconst webhookData = $('Webhook').first().json.body;\n\nconst expectedMake = (searchParams.make || '').toLowerCase();\nconst expectedModel = (searchParams.model || '').toLowerCase();\n\nlet comparables = [];\nconst seenIds = new Set();\n\nif (Array.isArray(items) && items.length > 0) {\n  comparables = items\n    .filter(item => {\n      // Get price (use priceNumeric if available)\n      const price = item.priceNumeric || parseFloat(String(item.price || '0').replace(/[^0-9.,]/g, '').replace(',', '.'));\n      \n      // Filter out lease prices (under 1000)\n      if (!price || price < 1000) return false;\n      \n      // Filter by correct make\n      const itemBrand = (item.brand || '').toLowerCase();\n      if (expectedMake && !itemBrand.includes(expectedMake)) return false;\n      \n      // Filter by correct model (check title and model field)\n      const itemModel = (item.model || '').toLowerCase();\n      const itemTitle = (item.title || '').toLowerCase();\n      if (expectedModel && !itemModel.includes(expectedModel) && !itemTitle.includes(expectedModel)) return false;\n      \n      // Remove duplicates by listingId or URL\n      const uniqueKey = item.listingId || item.url || '';\n      if (seenIds.has(uniqueKey)) return false;\n      seenIds.add(uniqueKey);\n      \n      return true;\n    })\n    .map(item => ({\n      price_eur: item.priceNumeric || parseFloat(String(item.price || '0').replace(/[^0-9.,]/g, '').replace(',', '.')),\n      mileage_km: item.mileageNumeric || parseInt(String(item.mileage || item.km || '0').replace(/\\\\D/g, '')),\n      title: item.title || '',\n      brand: item.brand || '',\n      model: item.model || '',\n      year: parseInt(item.year || '0'),\n      fuelType: item.fuelType || '',\n      transmission: item.transmission || '',\n      listingUrl: item.url || '',\n      listingId: item.listingId || '',\n      source: 'marktplaats'\n    }))\n    .slice(0, 20);\n}\n\n// Calculate statistics\nconst prices = comparables.map(c => c.price_eur).filter(p => p > 0);\nconst avgPrice = prices.length > 0 \n  ? Math.round(prices.reduce((a, b) => a + b, 0) / prices.length) \n  : 0;\nconst minPrice = prices.length > 0 ? Math.min(...prices) : 0;\nconst maxPrice = prices.length > 0 ? Math.max(...prices) : 0;\n\nreturn {\n  json: {\n    comparables: comparables,\n    statistics: {\n      count: comparables.length,\n      averagePrice: avgPrice,\n      minPrice: minPrice,\n      maxPrice: maxPrice\n    },\n    searchedFor: { make: expectedMake, model: expectedModel },\n    body: webhookData\n  }\n};"
      },
      "id": "parse-results",
      "name": "Parse Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1650, 200]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {
          "responseCode": 200,
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          }
        }
      },
      "id": "respond-success",
      "name": "Respond with Comparables",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [1850, 200]
    },
    {
      "parameters": {
        "jsCode": "// Return empty results if scraper timed out\nconst webhookData = $('Webhook').first().json.body;\n\nreturn {\n  json: {\n    comparables: [],\n    statistics: {\n      count: 0,\n      averagePrice: 0,\n      minPrice: 0,\n      maxPrice: 0\n    },\n    body: webhookData,\n    warning: 'Marktplaats scraper timed out - no comparables available'\n  }\n};"
      },
      "id": "empty-results",
      "name": "Empty Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1450, 500]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {
          "responseCode": 200,
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          }
        }
      },
      "id": "respond-empty",
      "name": "Respond Empty",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [1650, 500]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Build Search Parameters",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Search Parameters": {
      "main": [
        [
          {
            "node": "Start Apify Scraper",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Start Apify Scraper": {
      "main": [
        [
          {
            "node": "Wait 10s",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait 10s": {
      "main": [
        [
          {
            "node": "Check Run Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Run Status": {
      "main": [
        [
          {
            "node": "Is Finished?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Finished?": {
      "main": [
        [
          {
            "node": "Get Results",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Wait 5s More",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait 5s More": {
      "main": [
        [
          {
            "node": "Empty Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Results": {
      "main": [
        [
          {
            "node": "Parse Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Results": {
      "main": [
        [
          {
            "node": "Respond with Comparables",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Empty Results": {
      "main": [
        [
          {
            "node": "Respond Empty",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "driving-passion-arbitrage"
  },
  "pinData": {},
  "tags": [
    {
      "name": "driving-passion",
      "createdAt": "2026-01-25T00:00:00.000Z",
      "updatedAt": "2026-01-25T00:00:00.000Z"
    }
  ]
}
